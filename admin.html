<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - Новогодная Игра v5.3.5</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <!-- Конфигурация -->
    <script src="firebase-config.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header .version {
            color: #666;
            font-size: 16px;
            background: #f0f0f0;
            padding: 5px 15px;
            border-radius: 15px;
            display: inline-block;
        }

        /* Экран доступа */
        .access-screen {
            display: block;
            text-align: center;
            padding: 100px 0;
        }

        .access-screen:not(.active) {
            display: none;
        }

        .access-container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
        }

        .access-container h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .access-container input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .access-container input:focus {
            outline: none;
            border-color: #667eea;
        }

        .access-container button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .access-container button:hover {
            transform: translateY(-2px);
        }

        /* Основной контент */
        .admin-content {
            display: none;
        }

        .admin-content:not(.hidden) {
            display: block;
        }

        /* Вкладки */
        .tabs {
            display: flex;
            margin-bottom: 30px;
            background: white;
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .tab:hover:not(.active) {
            background: #f5f5f5;
        }

        /* Контент вкладок */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Карточки */
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card p {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        /* Кнопки */
        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f44336, #d32f2f);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* Формы */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Таблицы */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        tr:hover {
            background: #f8f9fa;
        }

        /* Статистика */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stat-card .number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card .label {
            color: #666;
            margin-top: 5px;
        }

        /* Уведомления */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            transform: translateX(100%);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: linear-gradient(135deg, #4CAF50, #45a049);
        }

        .notification.error {
            background: linear-gradient(135deg, #f44336, #d32f2f);
        }

        .notification.info {
            background: linear-gradient(135deg, #2196F3, #1976D2);
        }

        /* Модальные окна */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }

        .modal-content .btn-group {
            margin-top: 20px;
            justify-content: flex-end;
        }

        /* Списки задач */
        .task-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .task-item h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .task-item p {
            color: #666;
            font-size: 14px;
            margin: 0;
        }

        .task-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }

        /* QR код */
        #qrModal {
            text-align: center;
        }

        #qrModal img {
            max-width: 300px;
            border-radius: 8px;
        }

        /* Ошибки */
        #accessError {
            color: #f44336;
            margin-top: 10px;
            display: none;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                text-align: left;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                justify-content: center;
            }
        }

        /* Загрузка */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #667eea;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Анимация появления */
        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎄 Админ-панель Новогодней Игры</h1>
            <div class="version">v5.3.5 ФИНАЛЬНАЯ ВЕРСИЯ</div>
        </div>

        <!-- Экран доступа -->
        <div class="access-screen active" id="accessScreen">
            <div class="access-container">
                <h2>Вход в админ-панель</h2>
                <div class="form-group">
                    <input type="password" id="accessCode" placeholder="Введите код доступа">
                </div>
                <button onclick="checkAccess()">🔑 Войти</button>
                <div id="accessError"></div>
            </div>
        </div>

        <!-- Основной контент -->
        <div class="admin-content hidden" id="adminContent">
            <!-- Вкладки -->
            <div class="tabs">
                <button class="tab active" onclick="switchTab('quick-actions')">⚡ Быстрые действия</button>
                <button class="tab" onclick="switchTab('game-management')">🎮 Управление игрой</button>
                <button class="tab" onclick="switchTab('results')">📊 Результаты</button>
                <button class="tab" onclick="switchTab('settings')">⚙️ Настройки</button>
            </div>

            <!-- Быстрые действия -->
            <div class="tab-content active" id="quick-actions">
                <div class="card">
                    <h3>🚀 Быстрые действия</h3>
                    <p>Основные функции для управления игрой</p>
                    
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="generateGameLink()">
                            📋 Скопировать ссылку на игру
                        </button>
                        
                        <button class="btn btn-success" onclick="downloadQRCode()">
                            📱 Скачать QR-код
                        </button>
                        
                        <button class="btn btn-warning" onclick="printInstructions()">
                            🖨️ Печать инструкций
                        </button>
                        
                        <button class="btn btn-primary" onclick="openGame()">
                            🎯 Открыть игру
                        </button>
                        
                        <button class="btn btn-info" onclick="showQRModal()">
                            👁️ Показать QR-код
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>🔍 Состояние системы</h3>
                    <div id="systemStatus">
                        <button class="btn btn-primary" onclick="checkSystem()">Проверить систему</button>
                        <div id="systemInfo" style="margin-top: 15px;"></div>
                    </div>
                </div>
            </div>

            <!-- Управление игрой -->
            <div class="tab-content" id="game-management">
                <div class="card">
                    <h3>📝 Управление заданиями</h3>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="addNewTask()">➕ Добавить задание</button>
                        <button class="btn btn-warning" onclick="editTask()">✏️ Редактировать</button>
                        <button class="btn btn-danger" onclick="deleteTask()">🗑️ Удалить</button>
                        <button class="btn btn-primary" onclick="loadTasks()">🔄 Загрузить задания</button>
                    </div>
                    <div class="task-list" id="taskList" style="margin-top: 20px;">
                        <p>Нажмите "Загрузить задания" для просмотра списка</p>
                    </div>
                </div>

                <div class="card">
                    <h3>💾 GitHub автосохранение</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>GitHub Владелец:</label>
                            <input type="text" id="githubOwner" value="fancifulaction-rgb">
                        </div>
                        <div class="form-group">
                            <label>Репозиторий:</label>
                            <input type="text" id="githubRepo" value="christmas_game">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Personal Access Token:</label>
                        <input type="password" id="githubToken" placeholder="Введите токен">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="setupGitHubIntegration()">💾 Настроить интеграцию</button>
                        <button class="btn btn-primary" onclick="testGitHubConnection()">🔗 Тестировать подключение</button>
                        <button class="btn btn-warning" onclick="autoSaveToGitHub()">🔄 Сохранить на GitHub</button>
                    </div>
                </div>
            </div>

            <!-- Результаты -->
            <div class="tab-content" id="results">
                <div class="card">
                    <h3>🏆 Лидерборд</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="loadResults()">🔄 Обновить результаты</button>
                        <button class="btn btn-success" onclick="exportResults()">📊 Экспорт в CSV</button>
                        <button class="btn btn-danger" onclick="clearResults()">🗑️ Очистить результаты</button>
                    </div>
                    
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>№</th>
                                    <th>Игрок</th>
                                    <th>Очки</th>
                                    <th>Задания</th>
                                    <th>Время</th>
                                    <th>Подсказки</th>
                                    <th>Легкие</th>
                                    <th>Средние</th>
                                    <th>Сложные</th>
                                    <th>Дата</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 20px;">
                                        📊 Нажмите "Обновить результаты" для загрузки данных
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <h3>📈 Статистика</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="number" id="totalGames">0</div>
                            <div class="label">Всего игр</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="averageScore">0</div>
                            <div class="label">Средний счет</div>
                        </div>
                        <div class="stat-card">
                            <div class="number" id="totalHints">0</div>
                            <div class="label">Всего подсказок</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Настройки -->
            <div class="tab-content" id="settings">
                <div class="card">
                    <h3>🔒 Безопасность</h3>
                    <div class="form-group">
                        <label>Текущий пароль:</label>
                        <input type="password" id="currentPassword">
                    </div>
                    <div class="form-group">
                        <label>Новый пароль:</label>
                        <input type="password" id="newPassword">
                    </div>
                    <div class="form-group">
                        <label>Подтвердить пароль:</label>
                        <input type="password" id="confirmPassword">
                    </div>
                    <button class="btn btn-primary" onclick="changePassword()">
                        🔒 Изменить пароль
                    </button>
                </div>

                <div class="card">
                    <h3>🎮 Игровые настройки</h3>
                    <div class="form-group">
                        <label>Название игры:</label>
                        <input type="text" id="gameTitle" value="Новогодняя Охота за Сокровищами">
                    </div>
                    <div class="form-group">
                        <label>Описание игры:</label>
                        <textarea id="gameDescription" rows="3">Рождественская игра-поиск с заданиями для всей семьи!</textarea>
                    </div>
                    <button class="btn btn-success" onclick="saveGameSettings()">💾 Сохранить настройки</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div class="modal" id="qrModal" style="display: none;">
        <div class="modal-content">
            <h3>📱 QR-код игры</h3>
            <img id="qrCodeImage" src="" alt="QR-код">
            <div class="btn-group" style="margin-top: 20px; justify-content: center;">
                <button class="btn btn-primary" onclick="downloadQRCode()">💾 Скачать</button>
                <button class="btn btn-secondary" onclick="document.getElementById('qrModal').style.display = 'none'">❌ Закрыть</button>
            </div>
        </div>
    </div>

    <script>
        // Константы
        const GAME_ACCESS_CODE = 'ChristmasGame2025!';
        const GAME_URL = 'https://fancifulaction-rgb.github.io/christmas_game/index.html';
        
        // Глобальные переменные
        let firebaseApp = null;
        let firebaseDB = null;
        let gameTasks = [];
        let adminAccess = false;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            checkExistingAccess();
        });

        // ФУНКЦИИ ДОСТУПА
        function checkAccess() {
            const code = document.getElementById('accessCode').value;
            const currentPassword = localStorage.getItem('admin_password') || GAME_ACCESS_CODE;
            
            if (code === currentPassword) {
                localStorage.setItem('admin_access', 'true');
                document.getElementById('accessScreen').classList.remove('active');
                document.getElementById('adminContent').classList.remove('hidden');
                adminAccess = true;
                initFirebase();
                loadResults();
                showNotification('✅ Доступ разрешен!', 'success');
            } else {
                document.getElementById('accessError').textContent = '❌ Неверный код доступа!';
                document.getElementById('accessError').style.display = 'block';
                showNotification('❌ Неверный код доступа!', 'error');
            }
        }

        function checkExistingAccess() {
            if (localStorage.getItem('admin_access') === 'true') {
                document.getElementById('accessScreen').classList.remove('active');
                document.getElementById('adminContent').classList.remove('hidden');
                adminAccess = true;
                initFirebase();
                loadResults();
            }
        }

        // СМЕНА ПАРОЛЯ
        function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const storedPassword = localStorage.getItem('admin_password') || GAME_ACCESS_CODE;

            if (currentPassword !== storedPassword) {
                showNotification('❌ Текущий пароль неверный!', 'error');
                return;
            }

            if (newPassword.length < 4) {
                showNotification('❌ Новый пароль должен содержать минимум 4 символа!', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('❌ Новые пароли не совпадают!', 'error');
                return;
            }

            localStorage.setItem('admin_password', newPassword);
            showNotification('✅ Пароль успешно изменен!', 'success');
            
            // Очистка полей
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        // УПРАВЛЕНИЕ ТАБАМИ
        function switchTab(tabName) {
            // Убираем активный класс со всех табов
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Добавляем активный класс к выбранному табу
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Запускаем обновление результатов при переходе на вкладку результатов
            if (tabName === 'results') {
                loadResults();
            }
        }

        // FIREBASE ИНИЦИАЛИЗАЦИЯ
        function initFirebase() {
            try {
                if (typeof window.FIREBASE_CONFIG !== 'undefined') {
                    firebase.initializeApp(window.FIREBASE_CONFIG);
                    firebaseApp = firebase;
                    firebaseDB = firebase.database();
                    console.log('Firebase инициализирован успешно');
                    showNotification('✅ Firebase подключен!', 'success');
                } else {
                    console.error('Конфигурация Firebase не найдена');
                    showNotification('❌ Ошибка подключения к Firebase', 'error');
                }
            } catch (error) {
                console.error('Ошибка инициализации Firebase:', error);
                showNotification('❌ Ошибка подключения к Firebase', 'error');
            }
        }

        // ИГРОВЫЕ ФУНКЦИИ
        function generateGameLink() {
            const gameUrl = GAME_URL + '?access=' + 
                (localStorage.getItem('admin_password') || GAME_ACCESS_CODE);
            
            navigator.clipboard.writeText(gameUrl)
                .then(() => {
                    showNotification('✅ Ссылка скопирована в буфер обмена!', 'success');
                })
                .catch(() => {
                    // Fallback для старых браузеров
                    const textArea = document.createElement('textarea');
                    textArea.value = gameUrl;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('✅ Ссылка скопирована!', 'success');
                });
        }

        function downloadQRCode() {
            const gameUrl = GAME_URL + '?access=' + 
                (localStorage.getItem('admin_password') || GAME_ACCESS_CODE);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(gameUrl)}`;
            
            const link = document.createElement('a');
            link.href = qrUrl;
            link.download = 'christmas-game-qr.png';
            link.click();
            showNotification('📱 QR-код загружен!', 'success');
        }

        function printInstructions() {
            const gameUrl = GAME_URL + '?access=' + 
                (localStorage.getItem('admin_password') || GAME_ACCESS_CODE);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Инструкции для Новогодней Игры</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        h1 { color: #667eea; }
                        .qr-code { text-align: center; margin: 20px 0; }
                        .instructions { margin: 20px 0; }
                        .url { background: #f0f0f0; padding: 10px; border-radius: 5px; font-family: monospace; }
                    </style>
                </head>
                <body>
                    <h1>🎄 Новогодняя Охота за Сокровищами</h1>
                    <div class="qr-code">
                        <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(gameUrl)}" alt="QR-код игры">
                    </div>
                    <div class="instructions">
                        <h2>Как играть:</h2>
                        <ol>
                            <li>Отсканируйте QR-код или перейдите по ссылке</li>
                            <li>Введите название команды</li>
                            <li>Решайте задания по порядку</li>
                            <li>Собирайте очки и станьте чемпионом!</li>
                        </ol>
                        <h3>Ссылка на игру:</h3>
                        <div class="url">${gameUrl}</div>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function openGame() {
            const gameUrl = GAME_URL + '?access=' + 
                (localStorage.getItem('admin_password') || GAME_ACCESS_CODE);
            window.open(gameUrl, '_blank');
        }

        function showQRModal() {
            const gameUrl = GAME_URL + '?access=' + 
                (localStorage.getItem('admin_password') || GAME_ACCESS_CODE);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(gameUrl)}`;
            
            document.getElementById('qrCodeImage').src = qrUrl;
            document.getElementById('qrModal').style.display = 'flex';
        }

        // СИСТЕМНЫЕ ФУНКЦИИ
        function checkSystem() {
            const systemInfo = document.getElementById('systemInfo');
            
            let info = '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">';
            info += '<h4>🔍 Состояние системы:</h4>';
            info += '<ul style="list-style: none; padding: 0;">';
            
            // Проверка Firebase
            if (firebaseDB) {
                info += '<li style="color: green;">✅ Firebase подключен</li>';
            } else {
                info += '<li style="color: red;">❌ Firebase не подключен</li>';
            }
            
            // Проверка GitHub
            const githubConfig = JSON.parse(localStorage.getItem('github_config') || '{}');
            if (githubConfig.token) {
                info += '<li style="color: green;">✅ GitHub настроен</li>';
            } else {
                info += '<li style="color: orange;">⚠️ GitHub не настроен</li>';
            }
            
            // Проверка заданий
            info += `<li style="color: ${gameTasks.length > 0 ? 'green' : 'orange'};">📝 Заданий: ${gameTasks.length}</li>`;
            
            // Проверка пароля
            const storedPassword = localStorage.getItem('admin_password');
            if (storedPassword && storedPassword !== GAME_ACCESS_CODE) {
                info += '<li style="color: green;">🔑 Пользовательский пароль установлен</li>';
            } else {
                info += '<li style="color: orange;">⚠️ Используется стандартный пароль</li>';
            }
            
            info += '</ul></div>';
            systemInfo.innerHTML = info;
            
            showNotification('🔍 Проверка системы завершена', 'info');
        }

        // УПРАВЛЕНИЕ ЗАДАНИЯМИ
        function addNewTask() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>➕ Добавить новое задание</h3>
                    <form id="addTaskForm">
                        <div class="form-group">
                            <label>Название задания:</label>
                            <input type="text" id="taskTitle" required>
                        </div>
                        <div class="form-group">
                            <label>Код ответа:</label>
                            <input type="text" id="taskCode" required>
                        </div>
                        <div class="form-group">
                            <label>Сложность:</label>
                            <select id="taskDifficulty">
                                <option value="easy">Легкое</option>
                                <option value="medium">Среднее</option>
                                <option value="hard">Сложное</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Очки:</label>
                            <input type="number" id="taskPoints" value="10" min="1">
                        </div>
                        <div class="form-group">
                            <label>Подсказка:</label>
                            <textarea id="taskHint"></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-success">Добавить</button>
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Отмена</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            
            document.getElementById('addTaskForm').onsubmit = function(e) {
                e.preventDefault();
                const newTask = {
                    id: Date.now(),
                    question: document.getElementById('taskTitle').value,
                    code: document.getElementById('taskCode').value,
                    difficulty: document.getElementById('taskDifficulty').value,
                    points: parseInt(document.getElementById('taskPoints').value),
                    hint: document.getElementById('taskHint').value
                };
                
                // Сохранить в Firebase
                if (firebaseDB) {
                    firebase.database().ref('tasks').push(newTask)
                        .then(() => {
                            showNotification('✅ Задание добавлено!', 'success');
                            modal.remove();
                            loadTasks();
                        })
                        .catch(error => {
                            showNotification('❌ Ошибка: ' + error.message, 'error');
                        });
                } else {
                    showNotification('❌ Firebase не подключен', 'error');
                }
            };
        }

        function editTask() {
            if (gameTasks.length === 0) {
                showNotification('⚠️ Сначала загрузите задания', 'error');
                return;
            }
            
            const taskList = gameTasks.map((task, index) => 
                `${index + 1}. ${task.question} (${task.difficulty})`
            ).join('\n');
            
            const selected = prompt(`Выберите номер задания для редактирования:\n\n${taskList}`);
            const taskIndex = parseInt(selected) - 1;
            
            if (taskIndex >= 0 && taskIndex < gameTasks.length) {
                const task = gameTasks[taskIndex];
                const modal = document.createElement('div');
                modal.className = 'modal';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h3>✏️ Редактировать задание</h3>
                        <form id="editTaskForm">
                            <div class="form-group">
                                <label>Название задания:</label>
                                <input type="text" id="taskTitle" value="${task.question}" required>
                            </div>
                            <div class="form-group">
                                <label>Код ответа:</label>
                                <input type="text" id="taskCode" value="${task.code}" required>
                            </div>
                            <div class="form-group">
                                <label>Сложность:</label>
                                <select id="taskDifficulty">
                                    <option value="easy" ${task.difficulty === 'easy' ? 'selected' : ''}>Легкое</option>
                                    <option value="medium" ${task.difficulty === 'medium' ? 'selected' : ''}>Среднее</option>
                                    <option value="hard" ${task.difficulty === 'hard' ? 'selected' : ''}>Сложное</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Очки:</label>
                                <input type="number" id="taskPoints" value="${task.points}" min="1">
                            </div>
                            <div class="form-group">
                                <label>Подсказка:</label>
                                <textarea id="taskHint">${task.hint}</textarea>
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-success">Сохранить</button>
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Отмена</button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                
                document.getElementById('editTaskForm').onsubmit = function(e) {
                    e.preventDefault();
                    const updatedTask = {
                        question: document.getElementById('taskTitle').value,
                        code: document.getElementById('taskCode').value,
                        difficulty: document.getElementById('taskDifficulty').value,
                        points: parseInt(document.getElementById('taskPoints').value),
                        hint: document.getElementById('taskHint').value
                    };
                    
                    gameTasks[taskIndex] = { ...task, ...updatedTask };
                    
                    if (firebaseDB) {
                        firebase.database().ref('tasks').set(gameTasks)
                            .then(() => {
                                showNotification('✅ Задание обновлено!', 'success');
                                modal.remove();
                                loadTasks();
                            })
                            .catch(error => {
                                showNotification('❌ Ошибка: ' + error.message, 'error');
                            });
                    } else {
                        showNotification('✅ Задание обновлено в памяти', 'success');
                        modal.remove();
                        loadTasks();
                    }
                };
            }
        }

        function deleteTask() {
            if (gameTasks.length === 0) {
                showNotification('⚠️ Сначала загрузите задания', 'error');
                return;
            }
            
            const taskList = gameTasks.map((task, index) => 
                `${index + 1}. ${task.question}`
            ).join('\n');
            
            const selected = prompt(`Выберите номер задания для удаления:\n\n${taskList}`);
            const taskIndex = parseInt(selected) - 1;
            
            if (taskIndex >= 0 && taskIndex < gameTasks.length) {
                if (confirm('Удалить это задание?')) {
                    gameTasks.splice(taskIndex, 1);
                    
                    if (firebaseDB) {
                        firebase.database().ref('tasks').set(gameTasks)
                            .then(() => {
                                showNotification('✅ Задание удалено!', 'success');
                                loadTasks();
                            })
                            .catch(error => {
                                showNotification('❌ Ошибка: ' + error.message, 'error');
                            });
                    } else {
                        showNotification('✅ Задание удалено из памяти', 'success');
                        loadTasks();
                    }
                }
            }
        }

        function loadTasks() {
            const taskList = document.getElementById('taskList');
            taskList.innerHTML = '<div class="loading">Загружаются задания...</div>';
            
            // Попробовать загрузить из Firebase
            if (firebaseDB) {
                firebase.database().ref('tasks').once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        if (data) {
                            gameTasks = Object.values(data);
                        } else {
                            // Загрузить из локального файла
                            loadTasksFromFile();
                        }
                        renderTaskList();
                    })
                    .catch(error => {
                        console.log('Ошибка Firebase, загружаем из файла:', error);
                        loadTasksFromFile();
                    });
            } else {
                loadTasksFromFile();
            }
        }

        function loadTasksFromFile() {
            fetch('game-data.json')
                .then(response => response.json())
                .then(data => {
                    gameTasks = data;
                    renderTaskList();
                })
                .catch(error => {
                    console.error('Ошибка загрузки заданий:', error);
                    taskList.innerHTML = '<p>❌ Ошибка загрузки заданий</p>';
                });
        }

        function renderTaskList() {
            const taskList = document.getElementById('taskList');
            
            if (gameTasks.length === 0) {
                taskList.innerHTML = '<p>Задания не найдены</p>';
                return;
            }
            
            let html = '<h4>📝 Список заданий:</h4>';
            gameTasks.forEach((task, index) => {
                html += `
                    <div class="task-item">
                        <h4>${index + 1}. ${task.question}</h4>
                        <p><strong>Код:</strong> ${task.code} | <strong>Сложность:</strong> ${task.difficulty} | <strong>Очки:</strong> ${task.points}</p>
                        ${task.hint ? `<p><strong>Подсказка:</strong> ${task.hint}</p>` : ''}
                    </div>
                `;
            });
            
            taskList.innerHTML = html;
        }

        // РЕЗУЛЬТАТЫ
        function loadResults() {
            if (!firebaseDB) {
                document.getElementById('resultsBody').innerHTML = 
                    '<tr><td colspan="10" style="text-align: center; padding: 20px;">❌ Firebase не подключен</td></tr>';
                return;
            }
            
            document.getElementById('resultsBody').innerHTML = 
                '<tr><td colspan="10" style="text-align: center; padding: 20px;">Загружаются результаты...</td></tr>';
            
            firebase.database().ref('games').once('value')
                .then(snapshot => {
                    const games = snapshot.val();
                    if (!games) {
                        document.getElementById('resultsBody').innerHTML = 
                            '<tr><td colspan="10" style="text-align: center; padding: 20px;">Результатов пока нет</td></tr>';
                        return;
                    }
                    
                    const resultsArray = Object.entries(games).map(([key, game]) => ({
                        key,
                        playerName: game.playerName || game.teamName || 'Неизвестно',
                        totalScore: game.totalScore || 0,
                        completedTasks: game.completedTasks || 0,
                        gameTime: formatTime(game.gameDuration || 0),
                        hintsUsed: game.hintsUsed || 0,
                        easyTasks: game.difficultyStats?.easy || 0,
                        mediumTasks: game.difficultyStats?.medium || 0,
                        hardTasks: game.difficultyStats?.hard || 0,
                        endTime: new Date(game.endTime).toLocaleString('ru-RU')
                    }));
                    
                    resultsArray.sort((a, b) => b.totalScore - a.totalScore);
                    
                    const html = resultsArray.map((result, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${result.playerName}</td>
                            <td>${result.totalScore}</td>
                            <td>${result.completedTasks}</td>
                            <td>${result.gameTime}</td>
                            <td>${result.hintsUsed}</td>
                            <td>${result.easyTasks}</td>
                            <td>${result.mediumTasks}</td>
                            <td>${result.hardTasks}</td>
                            <td>${result.endTime}</td>
                        </tr>
                    `).join('');
                    
                    document.getElementById('resultsBody').innerHTML = html;
                    
                    // Обновить статистику
                    updateStats(resultsArray);
                    
                    showNotification(`✅ Результаты загружены: ${resultsArray.length}`, 'success');
                })
                .catch(error => {
                    document.getElementById('resultsBody').innerHTML = 
                        '<tr><td colspan="10" style="text-align: center; padding: 20px; color: red;">❌ Ошибка загрузки результатов</td></tr>';
                    showNotification('❌ Ошибка загрузки: ' + error.message, 'error');
                });
        }

        function updateStats(resultsArray) {
            const totalGames = resultsArray.length;
            const totalScore = resultsArray.reduce((sum, result) => sum + result.totalScore, 0);
            const totalHints = resultsArray.reduce((sum, result) => sum + result.hintsUsed, 0);
            
            document.getElementById('totalGames').textContent = totalGames;
            document.getElementById('averageScore').textContent = totalGames > 0 ? Math.round(totalScore / totalGames) : 0;
            document.getElementById('totalHints').textContent = totalHints;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function exportResults() {
            if (!firebaseDB) {
                showNotification('❌ Firebase не подключен', 'error');
                return;
            }
            
            firebase.database().ref('games').once('value')
                .then(snapshot => {
                    const games = snapshot.val();
                    if (!games) {
                        showNotification('⚠️ Нет данных для экспорта', 'error');
                        return;
                    }
                    
                    const resultsArray = Object.entries(games).map(([key, game]) => ({
                        Игрок: game.playerName || game.teamName || 'Неизвестно',
                        'Очки': game.totalScore || 0,
                        'Задания': game.completedTasks || 0,
                        'Время': formatTime(game.gameDuration || 0),
                        'Подсказки': game.hintsUsed || 0,
                        'Легкие': game.difficultyStats?.easy || 0,
                        'Средние': game.difficultyStats?.medium || 0,
                        'Сложные': game.difficultyStats?.hard || 0,
                        'Дата': new Date(game.endTime).toLocaleString('ru-RU')
                    }));
                    
                    const csv = convertToCSV(resultsArray);
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `christmas-game-results-${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();
                    
                    showNotification('📊 Результаты экспортированы!', 'success');
                })
                .catch(error => {
                    showNotification('❌ Ошибка экспорта: ' + error.message, 'error');
                });
        }

        function convertToCSV(array) {
            if (array.length === 0) return '';
            
            const headers = Object.keys(array[0]);
            const csvContent = [
                headers.join(','),
                ...array.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            return csvContent;
        }

        function clearResults() {
            if (!firebaseDB) {
                showNotification('❌ Firebase не подключен', 'error');
                return;
            }
            
            if (confirm('Удалить все результаты? Это действие нельзя отменить!')) {
                firebase.database().ref('games').remove()
                    .then(() => {
                        document.getElementById('resultsBody').innerHTML = 
                            '<tr><td colspan="10" style="text-align: center; padding: 20px;">Результаты очищены</td></tr>';
                        showNotification('🗑️ Результаты очищены!', 'success');
                    })
                    .catch(error => {
                        showNotification('❌ Ошибка: ' + error.message, 'error');
                    });
            }
        }

        // GITHUB ИНТЕГРАЦИЯ
        function setupGitHubIntegration() {
            const owner = document.getElementById('githubOwner').value;
            const repo = document.getElementById('githubRepo').value;
            const token = document.getElementById('githubToken').value;
            
            if (!token) {
                showNotification('❌ Введите Personal Access Token', 'error');
                return;
            }
            
            const config = {
                owner: owner,
                repo: repo,
                token: token,
                setupTime: new Date().toISOString()
            };
            
            localStorage.setItem('github_config', JSON.stringify(config));
            showNotification('✅ GitHub настройки сохранены!', 'success');
        }

        function testGitHubConnection() {
            const githubConfig = JSON.parse(localStorage.getItem('github_config') || '{}');
            
            if (!githubConfig.token) {
                showNotification('❌ Сначала настройте интеграцию', 'error');
                return;
            }
            
            const url = `https://api.github.com/repos/${githubConfig.owner}/${githubConfig.repo}`;
            
            fetch(url, {
                headers: {
                    'Authorization': `token ${githubConfig.token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            })
            .then(response => {
                if (response.ok) {
                    showNotification('✅ GitHub подключение успешно!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            })
            .catch(error => {
                showNotification('❌ Ошибка подключения: ' + error.message, 'error');
            });
        }

        function autoSaveToGitHub() {
            const githubConfig = JSON.parse(localStorage.getItem('github_config') || '{}');
            
            if (!githubConfig.token) {
                showNotification('❌ Настройте GitHub интеграцию сначала', 'error');
                return;
            }
            
            const config = {
                owner: githubConfig.owner,
                repo: githubConfig.repo,
                token: githubConfig.token
            };
            
            const gameData = {
                title: "Новогодняя Охота за Сокровищами",
                lastUpdated: new Date().toISOString(),
                tasks: gameTasks
            };
            
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(gameData, null, 2))));
            const url = `https://api.github.com/repos/${config.owner}/${config.repo}/contents/game-data.json`;
            
            fetch(url, {
                method: 'PUT',
                headers: {
                    'Authorization': `token ${config.token}`,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    message: 'Обновление заданий через админ-панель',
                    content: content
                })
            })
            .then(response => {
                if (response.ok) {
                    showNotification('✅ Задания сохранены на GitHub!', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            })
            .catch(error => {
                console.error('Ошибка сохранения на GitHub:', error);
                showNotification('❌ Ошибка сохранения: ' + error.message, 'error');
            });
        }

        // НАСТРОЙКИ ИГРЫ
        function saveGameSettings() {
            const gameTitle = document.getElementById('gameTitle').value;
            const gameDescription = document.getElementById('gameDescription').value;
            
            const settings = {
                title: gameTitle,
                description: gameDescription,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('game_settings', JSON.stringify(settings));
            showNotification('✅ Настройки игры сохранены!', 'success');
        }

        // УВЕДОМЛЕНИЯ
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 3000);
        }

        // Выход
        function logout() {
            localStorage.removeItem('admin_access');
            location.reload();
        }
    </script>
</body>
</html>